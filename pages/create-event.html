<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Event | UniversityHub</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6">
        <!-- Header Banner -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6 border-l-4 border-indigo-600">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Create New Event</h1>
                    <p class="text-gray-600 mt-1">Fill in the details to schedule a new event</p>
                </div>
                <div class="hidden sm:block">
                    <a href="dashboard.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Create Event Form -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
            <div class="border-b border-gray-200 px-6 py-4">
                <h2 class="text-lg font-semibold text-gray-800">Event Information</h2>
            </div>
            <form class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Event Name -->
                    <div class="col-span-2">
                        <label for="event-name" class="block text-sm font-medium text-gray-700 mb-1">Event Name*</label>
                        <input type="text" id="event-name"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                            placeholder="Enter event name" required>
                    </div>

                    <!-- Event Type and Category -->
                    <div>
                        <label for="event-category" class="block text-sm font-medium text-gray-700 mb-1">Category*</label>
                        <select id="event-category" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                            <option value="">Select a category</option>
                            <option value="school">School</option>
                            <option value="department">Department</option>
                            <option value="organization">Organization</option>
                        </select>
                    </div>
                    <div id="department-select-container" class="hidden">
                        <label for="event-department" class="block text-sm font-medium text-gray-700 mb-1">Department*</label>
                        <select id="event-department" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select>
                    </div>
                    <div id="organization-select-container" class="hidden">
                        <label for="event-organization" class="block text-sm font-medium text-gray-700 mb-1">Organization*</label>
                        <select id="event-organization" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select>
                    </div>

                    <!-- Event Visibility -->
                    <div>
                        <label for="event-visibility"
                            class="block text-sm font-medium text-gray-700 mb-1">Visibility</label>
                        <select id="event-visibility"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <option value="public">Public</option>
                            <option value="private">Private (Invitation only)</option>
                            <option value="department">Department Only</option>
                        </select>
                    </div>

                    <!-- Date and Time -->
                    <div>
                        <label for="event-date" class="block text-sm font-medium text-gray-700 mb-1">Event Date*</label>
                        <input type="date" id="event-date"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                            required>
                    </div>

                    <div>
                        <label for="event-time" class="block text-sm font-medium text-gray-700 mb-1">Event Time*</label>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="time" id="event-start-time"
                                class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                                required>
                            <input type="time" id="event-end-time"
                                class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                                required>
                        </div>
                    </div>

                    <!-- Location -->
                    <div>
                        <label for="event-location"
                            class="block text-sm font-medium text-gray-700 mb-1">Location*</label>
                        <input type="text" id="event-location"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                            placeholder="Building and room number" required>
                    </div>

                    <!-- Capacity -->
                    <div>
                        <label for="event-capacity" class="block text-sm font-medium text-gray-700 mb-1">Maximum
                            Capacity</label>
                        <input type="number" id="event-capacity"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                            placeholder="0 for unlimited">
                    </div>

                    <!-- Description -->
                    <div class="col-span-2">
                        <label for="event-description"
                            class="block text-sm font-medium text-gray-700 mb-1">Description*</label>
                        <textarea id="event-description" rows="4"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                            placeholder="Describe your event" required></textarea>
                    </div>

                    <!-- Organizer Info -->
                    <div class="col-span-2">
                        <h3 class="font-medium text-gray-800 mb-3">Organizer Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="organizer-name" class="block text-sm font-medium text-gray-700 mb-1">Contact
                                    Name*</label>
                                <input type="text" id="organizer-name"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                                    required>
                            </div>
                            <div>
                                <label for="organizer-email"
                                    class="block text-sm font-medium text-gray-700 mb-1">Contact Email*</label>
                                <input type="email" id="organizer-email"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                                    required>
                            </div>
                        </div>
                    </div>

                    <!-- Event Options -->
                    <div class="col-span-2">
                        <h3 class="font-medium text-gray-800 mb-3">Event Options</h3>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="registration-required" class="rounded text-indigo-600 focus:ring-indigo-500">
                                <label for="registration-required" class="ml-2 text-sm text-gray-700">Require registration</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="send-reminders" class="rounded text-indigo-600 focus:ring-indigo-500">
                                <label for="send-reminders" class="ml-2 text-sm text-gray-700">Send reminder notifications</label>
                            </div>
                        </div>
                    </div>

                    <!-- Event Image -->
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Event Image</label>
                        <div id="event-image-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer transition hover:border-indigo-400">
                            <div class="space-y-2" id="event-image-dropzone-content">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                                <p class="text-sm text-gray-500">Click to upload or drag and drop</p>
                                <p class="text-xs text-gray-400">PNG, JPG up to 2MB</p>
                            </div>
                            <img id="event-image-preview" src="" alt="Preview" class="mx-auto mt-2 max-h-40 hidden" />
                        </div>
                        <input type="file" class="hidden" id="event-image" accept="image/*">
                    </div>

                    <!-- Custom Registration Link -->
                    <div class="col-span-2">
                        <label for="custom-registration-link" class="block text-sm font-medium text-gray-700 mb-1">Custom Registration Link (optional)</label>
                        <input type="url" id="custom-registration-link"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                            placeholder="https://your-form-link.com">
                        <p class="text-xs text-gray-400 mt-1">If you have your own registration form, paste the link here. A QR code will be generated for it.</p>
                    </div>
                </div>

                <!-- Form Buttons -->
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="btn btn-secondary">
                        Save as Draft
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Create Event
                    </button>
                </div>
            </form>
        </div>

        <!-- Registration Link and QR Code (hidden by default) -->
        <div id="event-registration-info" class="bg-white rounded-lg shadow-sm p-6 mb-6 border-l-4 border-green-600 hidden">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Event Registration</h2>
            <p class="mb-2">Share this link with students to register for the event:</p>
            <a id="event-registration-link" href="#" class="text-indigo-600 underline break-all" target="_blank"></a>
            <div class="mt-4 flex justify-center items-center">
                <div id="event-registration-qr" class="w-60 h-60 max-w-full"></div>
            </div>
        </div>
    </div>

    <!-- jQuery and jquery-qrcode -->
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../js/jquery.qrcode.min.js"></script>
    <script src="../js/utils.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        setPageTitle('Create Event');
        // Fetch departments and organizations for dropdowns
        async function populateDropdown(url, selectId) {
            const res = await fetch(url);
            const data = await res.json();
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select</option>' + data.map(item => `<option value="${item._id}">${item.name}</option>`).join('');
        }
        const token = localStorage.getItem('token');
        let user = null;
        if (token) {
            try {
                const res = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    user = await res.json();
                }
            } catch (e) { /* ignore */ }
        }

        // Show/hide department/org dropdowns based on category
        document.getElementById('event-category').addEventListener('change', function() {
            document.getElementById('department-select-container').classList.add('hidden');
            document.getElementById('organization-select-container').classList.add('hidden');
            if (this.value === 'department') {
                document.getElementById('department-select-container').classList.remove('hidden');
            } else if (this.value === 'organization') {
                document.getElementById('organization-select-container').classList.remove('hidden');
            }
        });

        // Populate department/org dropdowns
        if (user && user.role === 'student_leader') {
            // Student leader: only show their department/org
            if (user.isDepartmentLeader && user.department) {
                const deptSelect = document.getElementById('event-department');
                deptSelect.innerHTML = `<option value="${user.department._id || user.department}">${user.department.name || user.department}</option>`;
                deptSelect.disabled = true;
            }
            if (user.isOrganizationLeader && user.organization) {
                const orgSelect = document.getElementById('event-organization');
                orgSelect.innerHTML = `<option value="${user.organization._id || user.organization}">${user.organization.name || user.organization}</option>`;
                orgSelect.disabled = true;
            }
        } else if (user && user.role === 'faculty') {
            // Faculty: only show their department
            if (user.department) {
                const deptSelect = document.getElementById('event-department');
                deptSelect.innerHTML = `<option value="${user.department._id || user.department}">${user.department.name || user.department}</option>`;
                deptSelect.disabled = true;
            }
            // Organization dropdown remains unrestricted for faculty
            await populateDropdown('/api/events/organizations/all', 'event-organization');
        } else {
            // Not a student leader or faculty: show all
            await populateDropdown('/api/events/departments/all', 'event-department');
            await populateDropdown('/api/events/organizations/all', 'event-organization');
        }

        // Image upload logic
        const dropzone = document.getElementById('event-image-dropzone');
        const fileInput = document.getElementById('event-image');
        const previewImg = document.getElementById('event-image-preview');
        const dropzoneContent = document.getElementById('event-image-dropzone-content');

        dropzone.addEventListener('click', () => fileInput.click());
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-indigo-400');
        });
        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-indigo-400');
        });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-indigo-400');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                fileInput.files = e.dataTransfer.files;
                showImagePreview(fileInput.files[0]);
            }
        });
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                showImagePreview(this.files[0]);
            }
        });
        function showImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewImg.classList.remove('hidden');
                dropzoneContent.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    });

    // Handle event creation form submission
    const form = document.querySelector('form');
    const registrationInfo = document.getElementById('event-registration-info');
    const registrationLink = document.getElementById('event-registration-link');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get the JWT token from localStorage
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Please log in to create an event');
            window.location.href = '/login.html';
            return;
        }

        // Decode the token to get the user ID
        const decoded = jwt_decode(token);
        const organizerId = decoded.userId || decoded.id || decoded._id; // Try common keys

        // Log token for debugging (remove in production)
        console.log('Token exists:', !!token);
        console.log('Decoded token:', decoded);
        console.log('Organizer ID:', organizerId);

        // Gather form data
        const data = {
            title: document.getElementById('event-name').value,
            category: document.getElementById('event-category').value,
            date: new Date(document.getElementById('event-date').value).toISOString(),
            time: document.getElementById('event-start-time').value + ' - ' + document.getElementById('event-end-time').value,
            location: document.getElementById('event-location').value,
            maxParticipants: parseInt(document.getElementById('event-capacity').value) || 0,
            description: document.getElementById('event-description').value,
            organizer: organizerId
        };

        // Add department/organization if selected
        const category = document.getElementById('event-category').value;
        if (category === 'department') {
            const dept = document.getElementById('event-department').value;
            if (dept) data.department = dept;
        } else if (category === 'organization') {
            const org = document.getElementById('event-organization').value;
            if (org) data.organization = org;
        }

        // Handle pubmat upload as base64
        const imageInput = document.getElementById('event-image');
        if (imageInput.files && imageInput.files[0]) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                data.pubmat = e.target.result; // base64 string
                await submitEvent(data, token);
            };
            reader.readAsDataURL(imageInput.files[0]);
            return;
        }

        await submitEvent(data, token);
    });

    async function submitEvent(data, token) {
        const customLink = document.getElementById('custom-registration-link').value.trim();
        if (customLink) {
            data.customRegistrationLink = customLink;
        }
        try {
            // Send POST request to backend
            const res = await fetch('/api/events', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const event = await res.json();
                // Show registration link and QR code
                const regUrl = window.location.origin + '/event-register.html?id=' + event._id;
                registrationLink.href = regUrl;
                registrationLink.textContent = regUrl;
                
                // Generate QR code for default registration link (use regUrl directly)
                $('#event-registration-qr').empty().qrcode(regUrl);
                
                // If custom registration link is provided, generate QR code for it
                if (customLink) {
                    registrationLink.href = customLink;
                    registrationLink.textContent = customLink;
                    $('#event-registration-qr').empty().qrcode(customLink);
                }
                
                registrationInfo.classList.remove('hidden');
                window.scrollTo({ top: registrationInfo.offsetTop, behavior: 'smooth' });
            } else {
                const error = await res.json();
                if (res.status === 401) {
                    // Handle unauthorized error
                    alert('Your session has expired. Please log in again.');
                    localStorage.removeItem('token'); // Clear invalid token
                    window.location.href = '/login.html';
                } else {
                    alert('Failed to create event: ' + (error.message || 'Please check your input'));
                }
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to create event. Please try again.');
        }
    }
    </script>
</body>

</html>